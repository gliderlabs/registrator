<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic|Vollkorn:400,700' rel='stylesheet' type='text/css'>
        
        
        <link rel="canonical" href="https://gliderlabs.com/registrator/user/services/">
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>Service Model - Registrator</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.4.0.min.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Registrator</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">Readme</a>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">User Guide <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../quickstart/">Quickstart</a>
                        </li>
                    
                        <li >
                            <a href="../run/">Run Reference</a>
                        </li>
                    
                        <li class="active">
                            <a href="./">Service Model</a>
                        </li>
                    
                        <li >
                            <a href="../backends/">Registry Backends</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developer Guide <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../dev/backends/">Contributing Backends</a>
                        </li>
                    
                        <li >
                            <a href="../../dev/releases/">Staging Releases</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <!--li >
                    <a rel="next" href="../run/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../backends/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li-->
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Versions <b class="caret"></b></a>
                    <ul class="dropdown-menu" id="versions-dropdown">
                    </ul>
                </li>
                <li>
                    <a href="http://glider-slackin.herokuapp.com/">
                        <i class="fa fa-slack"></i>
                        Community
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/gliderlabs/registrator">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#service-object">Service Object</a></li>
        
            <li><a href="#container-overrides">Container Overrides</a></li>
        
            <li><a href="#detecting-services">Detecting Services</a></li>
        
            <li><a href="#service-name">Service Name</a></li>
        
            <li><a href="#ip-and-port">IP and Port</a></li>
        
            <li><a href="#tags-and-attributes">Tags and Attributes</a></li>
        
            <li><a href="#unique-id">Unique ID</a></li>
        
            <li><a href="#examples">Examples</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-8 content" role="main">

<h1 id="service-object">Service Object</h1>
<p>Registrator is primarily concerned with services that would be added to a
service discovery registry. In our case, a service is anything listening on a
port. If a container listens on multiple ports, it has multiple services.</p>
<p>Services are created with information from the container, including user-defined
metadata on the container, into an intermediary service object. This service
object is then passed to a registry backend to try and place as much of this
object into a particular registry.</p>
<pre><code>type Service struct {
    ID    string               // unique service instance ID
    Name  string               // service name
    IP    string               // IP address service is located at
    Port  int                  // port service is listening on
    Tags  []string             // extra tags to classify service
    Attrs map[string]string    // extra attribute metadata
}
</code></pre>
<h2 id="container-overrides">Container Overrides</h2>
<p>The fields <code>Name</code>, <code>Tags</code>, <code>Attrs</code>, and <code>ID</code> can be overridden by user-defined
container metadata. You can use environment variables or labels prefixed with
<code>SERVICE_</code> or <code>SERVICE_x_</code> to set values, where <code>x</code> is the internal exposed port.
For example <code>SERVICE_NAME=customerdb</code> and <code>SERVICE_80_NAME=api</code>.</p>
<p>You use a port in the key name to refer to a particular service on that port.
Metadata variables without a port in the name are used as the default for all
services or can be used to conveniently refer to the single exposed service.</p>
<p>The <code>Attrs</code> field is populated by metadata using any other field names in the
key name. For example, <code>SERVICE_REGION=us-east</code>.</p>
<p>Since metadata is stored as environment variables or labels, the container
author can include their own metadata defined in the Dockerfile. The operator
will still be able to override these author-defined defaults.</p>
<h2 id="detecting-services">Detecting Services</h2>
<p>By default, you can expect Registrator to pick up services from containers that
have <em>explicitly published ports</em> (eg, using <code>-p</code> or <code>-P</code>). This is true for
containers running in host network mode as well, so you'll have to publish ports
even though it doesn't do anything networking wise:</p>
<pre><code>$ docker run --net=host -p 8080:8080 -p 8443:8443 ...
</code></pre>
<p>If running with the <code>-internal</code> option, it will instead look for exposed ports.
These can be implicitly set from the Dockerfile or explicitly set with <code>docker run
--expose=8080 ...</code>.</p>
<p>You can also tell Registrator to ignore a container by setting a
label or environment variable for <code>SERVICE_IGNORE</code>.</p>
<h2 id="service-name">Service Name</h2>
<p>Service names are what you use in service discovery lookups. By default, the
service name is determined by this pattern:</p>
<pre><code>&lt;base(container-image)&gt;[-&lt;exposed-port&gt; if &gt;1 ports]
</code></pre>
<p>Using the base of the container image, if the image is <code>gliderlabs/foobar</code>, the
service name is <code>foobar</code>. If the image is <code>redis</code> the service name is simply
<code>redis</code>.</p>
<p>Additionally, if a container has multiple exposed ports, it will append the
internal exposed port to differentiate from each other. For example, an image
<code>nginx</code> with two exposed ports, 80 and 443, will produce two services named
<code>nginx-80</code> and <code>nginx-443</code>.</p>
<p>You can override this default name with label or environment variable
<code>SERVICE_NAME</code> or <code>SERVICE_x_NAME</code>, where <code>x</code> is the internal exposed port.</p>
<h2 id="ip-and-port">IP and Port</h2>
<p>IP and port make up the address that the service name resolves to. There are a
number of ways Registrator can determine IP and port depending your setup. By
default, port is the public <em>published</em> port and the IP is going to try and be
your host IP.</p>
<p>Since determining the right IP is difficult to do automatically, it's recommended
to use the <code>-ip</code> option to explicitly tell Registrator what IP to use.</p>
<p>If you use the <code>-internal</code> option, Registrator will use the <em>exposed</em> port <strong>and
Docker-assigned internal IP of the container</strong>.</p>
<h2 id="tags-and-attributes">Tags and Attributes</h2>
<p>Tags and attributes are extra metadata fields for services. Not all backends
support them. In fact, currently Consul supports tags and none support
attributes.</p>
<p>Attributes can also be used by backends for registry specific features, not just
generic metadata. For example, Consul uses them for specifying HTTP health
checks.</p>
<h2 id="unique-id">Unique ID</h2>
<p>The ID is a cluster-wide unique identifier for this service instance. For the
most part, it's an implementation detail, as users typically use service names,
not their IDs. Registrator comes up with a human-friendly string that encodes
useful information in the ID based on this pattern:</p>
<pre><code>&lt;hostname&gt;:&lt;container-name&gt;:&lt;exposed-port&gt;[:udp if udp]
</code></pre>
<p>The ID includes the hostname to help you identify which host this service is
running on. This is why running Registrator in host network mode or setting
Registrator's hostname to the host's hostname is important. Otherwise it will be
the ID of the Registrator container, which is not terribly useful.</p>
<p>The name of the container for this service is also included. It uses the name
instead of container ID because it's more human-friendly and user configurable.</p>
<p>To identify this particular service in the container, it uses the internal
exposed port. This represents the port the service is listening on inside the
container. We use this because it likely better represents the service than the
publicly published port. A published port might be an arbitrary 54292, whereas
the exposed port might be 80, showing that it's an HTTP service.</p>
<p>Lastly, if the service is identified as UDP, this is included in the ID to
differentiate from a TCP service that could be listening on the same port.</p>
<p>Although this can be overridden on containers with <code>SERVICE_ID</code> or
<code>SERVICE_x_ID</code>, it is not recommended.</p>
<h2 id="examples">Examples</h2>
<h3 id="single-service-with-defaults">Single service with defaults</h3>
<pre><code>$ docker run -d --name redis.0 -p 10000:6379 progrium/redis
</code></pre>
<p>Results in <code>Service</code>:</p>
<pre><code>{
    "ID": "hostname:redis.0:6379",
    "Name": "redis",
    "Port": 10000,
    "IP": "192.168.1.102",
    "Tags": [],
    "Attrs": {}
}
</code></pre>
<h3 id="single-service-with-metadata">Single service with metadata</h3>
<pre><code>$ docker run -d --name redis.0 -p 10000:6379 \
    -e "SERVICE_NAME=db" \
    -e "SERVICE_TAGS=master,backups" \
    -e "SERVICE_REGION=us2" progrium/redis
</code></pre>
<p>Results in <code>Service</code>:</p>
<pre><code>{
    "ID": "hostname:redis.0:6379",
    "Name": "db",
    "Port": 10000,
    "IP": "192.168.1.102",
    "Tags": ["master", "backups"],
    "Attrs": {"region": "us2"}
}
</code></pre>
<p>Keep in mind not all of the <code>Service</code> object may be used by the registry backend. For example, currently none of them support registering arbitrary attributes. This field is there for future use.</p>
<h3 id="multiple-services-with-defaults">Multiple services with defaults</h3>
<pre><code>$ docker run -d --name nginx.0 -p 4443:443 -p 8000:80 progrium/nginx
</code></pre>
<p>Results in two <code>Service</code> objects:</p>
<pre><code>[
    {
        "ID": "hostname:nginx.0:443",
        "Name": "nginx-443",
        "Port": 4443,
        "IP": "192.168.1.102",
        "Tags": [],
        "Attrs": {},
    },
    {
        "ID": "hostname:nginx.0:80",
        "Name": "nginx-80",
        "Port": 8000,
        "IP": "192.168.1.102",
        "Tags": [],
        "Attrs": {}
    }
]
</code></pre>
<h3 id="multiple-services-with-metadata">Multiple services with metadata</h3>
<pre><code>$ docker run -d --name nginx.0 -p 4443:443 -p 8000:80 \
    -e "SERVICE_443_NAME=https" \
    -e "SERVICE_443_ID=https.12345" \
    -e "SERVICE_443_SNI=enabled" \
    -e "SERVICE_80_NAME=http" \
    -e "SERVICE_TAGS=www" progrium/nginx
</code></pre>
<p>Results in two <code>Service</code> objects:</p>
<pre><code>[
    {
        "ID": "https.12345",
        "Name": "https",
        "Port": 4443,
        "IP": "192.168.1.102",
        "Tags": ["www"],
        "Attrs": {"sni": "enabled"},
    },
    {
        "ID": "hostname:nginx.0:80",
        "Name": "http",
        "Port": 8000,
        "IP": "192.168.1.102",
        "Tags": ["www"],
        "Attrs": {}
    }
]
</code></pre>
<h3 id="using-labels-to-define-metadata">Using labels to define metadata</h3>
<pre><code>$ docker run -d --name redis.0 -p 10000:6379 \
    -l "SERVICE_NAME=db" \
    -l "SERVICE_TAGS=master,backups" \
    -l "SERVICE_REGION=us2" dockerfile/redis
</code></pre>
<p>Results in <code>Service</code>:</p>
<pre><code>{
    "ID": "hostname:redis.0:6379",
    "Name": "db",
    "Port": 10000,
    "IP": "192.168.1.102",
    "Tags": ["master", "backups"],
    "Attrs": {"region": "us2"}
}
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Documentation built with <a href="https://gliderlabs.com/pagebuilder">Pagebuilder</a>.</center>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script src="../../js/base.js"></script>
        <script>
          $( document ).ready(function() {
              $.getJSON("https://gliderlabs.com/registrator/versions.json", function(data) {
                $("#versions-dropdown").append('<li><a href="https://gliderlabs.com/registrator/latest">latest ('+data.latest+')</a></li>');
                $.each(data.versions, function( index, value ) {
                  $("#versions-dropdown").append('<li><a href="https://gliderlabs.com/registrator/'+value+'">'+value+'</a></li>');
                });
              });
          });
        </script>
    </body>
</html>